name: Security Analysis Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run weekly security scans every Monday at 9 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  snyk-scan:
    name: Snyk Dependency Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Install dependencies (Backend)
        working-directory: ./golang-gin-realworld-example-app
        run: go mod download
      
      - name: Install dependencies (Frontend)
        working-directory: ./react-redux-realworld-example-app
        run: npm install
      
      - name: Run Snyk Security Scan (Backend)
        uses: snyk/actions/golang@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=golang-gin-realworld-example-app/go.mod
      
      - name: Run Snyk Security Scan (Frontend)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          command: test
      
      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  sonarcloud-backend:
    name: SonarCloud Backend Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Run tests with coverage
        working-directory: ./golang-gin-realworld-example-app
        run: |
          go test -v -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html
      
      - name: SonarCloud Scan (Backend)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: golang-gin-realworld-example-app
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=realworld-backend
            -Dsonar.sources=.
            -Dsonar.exclusions=**/*_test.go,**/vendor/**
            -Dsonar.tests=.
            -Dsonar.test.inclusions=**/*_test.go
            -Dsonar.go.coverage.reportPaths=coverage.out
            -Dsonar.verbose=true

  sonarcloud-frontend:
    name: SonarCloud Frontend Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
      
      - name: Install dependencies
        working-directory: ./react-redux-realworld-example-app
        run: npm install
      
      - name: Run tests with coverage
        working-directory: ./react-redux-realworld-example-app
        run: npm test -- --coverage --watchAll=false
        continue-on-error: true
      
      - name: SonarCloud Scan (Frontend)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: react-redux-realworld-example-app
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=realworld-frontend
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.verbose=true

  owasp-zap-scan:
    name: OWASP ZAP Dynamic Scan
    runs-on: ubuntu-latest
    needs: [snyk-scan, sonarcloud-backend, sonarcloud-frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
      
      - name: Build and start backend
        working-directory: ./golang-gin-realworld-example-app
        run: |
          go mod download
          CGO_ENABLED=1 go build -o realworld-server hello.go
          ./realworld-server &
          sleep 10
        continue-on-error: true
      
      - name: Build and start frontend
        working-directory: ./react-redux-realworld-example-app
        run: |
          npm install
          npm start &
          sleep 30
        continue-on-error: true
      
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:4100'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
      
      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:8080/api'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
      
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-reports
          path: |
            report_html.html
            report_json.json
            report_md.md

  security-summary:
    name: Generate Security Summary
    runs-on: ubuntu-latest
    needs: [snyk-scan, sonarcloud-backend, sonarcloud-frontend, owasp-zap-scan]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate security summary
        run: |
          echo "# Security Analysis Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Analysis Date:** $(date)" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "✅ Snyk Dependency Scan: ${{ needs.snyk-scan.result }}" >> security-summary.md
          echo "✅ SonarCloud Backend: ${{ needs.sonarcloud-backend.result }}" >> security-summary.md
          echo "✅ SonarCloud Frontend: ${{ needs.sonarcloud-frontend.result }}" >> security-summary.md
          echo "✅ OWASP ZAP Scan: ${{ needs.owasp-zap-scan.result }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Dashboard Links" >> security-summary.md
          echo "" >> security-summary.md
          echo "- [Snyk Dashboard](https://app.snyk.io/org/${{ secrets.SNYK_ORG_ID }})" >> security-summary.md
          echo "- [SonarCloud Dashboard](https://sonarcloud.io/organizations/${{ secrets.SONAR_ORGANIZATION }})" >> security-summary.md
          echo "- [GitHub Security](https://github.com/${{ github.repository }}/security)" >> security-summary.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
